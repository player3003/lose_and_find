# 校园失物招领智能推荐系统

基于 Flask + SQLAlchemy 实现的失物招领管理平台。系统内置规则型智能体，能够在用户提交失物或招领信息后自动完成匹配并给出推荐等级，满足课程《智能体系统设计与实现》报告中的主要功能与非功能要求。

## 功能亮点

- 失物 / 招领信息提交、浏览与管理，支持查看详细信息。
- 支持一键删除失物/招领记录，自动级联清理历史推荐。
- 用户注册、登录与会话管理，操作记录自动关联账号。
- 分离设计：**我的记录** 模块展示个人数据，**最新记录** 模块展示全量数据。
- 规则型智能体执行感知-决策-执行流程：
  - 感知：自动拉取数据库中可匹配的候选记录。
  - **决策**：采用权重化的多规则评分系统，结合类别(40%)、地点(30%)、时间(15%)与描述相似度(15%)等因素，计算精准的匹配得分。
  - 执行：写入 `match_results` 表并在界面展示推荐等级与理由。
- **个人控制的智能匹配**：仅在个人记录详情页通过"启动智能体匹配"按钮触发，不自动运行。
- 推荐表格支持“确认完成”操作，标记成功匹配并阻止后续自动覆盖。
- Bootstrap 前端界面，支持快速查看近期记录与推荐结果。
- Docker 一键部署，支持 `docker compose up` 启动。
- 单元测试验证智能体规则的正确性。
- 普通用户仅能查看自己的失物与招领记录，管理员账户可以浏览全量并执行删除等管理操作。

## 环境准备

- Python 3.11 及以上版本，确保已安装 `pip`
- Git（推荐）用于克隆代码仓库
- 可选：Docker Desktop（若需要容器化部署）
- Windows 用户建议使用 PowerShell；macOS/Linux 均可使用终端

## 本地运行

1. 克隆仓库并进入目录：
   ```powershell
   git clone <你的仓库地址> lost-and-found-agent
   cd lost-and-found-agent
   ```
2. 准备虚拟环境并安装依赖：
   ```powershell
   python -m venv .venv
   .venv\Scripts\activate
   pip install --upgrade pip
   pip install -r requirements.txt
   ```
3. 初始化环境变量（可选）：
   ```powershell
   set FLASK_APP=app.py
   set FLASK_ENV=development
   # 如需自定义数据库路径：
   # set DATABASE_URL=sqlite:///data/lost_and_found.db
   ```
4. 创建 SQLite 目录（自定义路径时需要）：
   ```powershell
   mkdir data
   ```
5. 启动开发服务器：
   ```powershell
   flask run --debug
   ```
6. 打开浏览器访问 http://127.0.0.1:5000 并按以下流程体验：
   - 首次使用请点击右上角“注册”创建账号，并登录系统。
   - 在"发布失物信息"表单中填写类别、地点、描述，提交后会添加到个人的失物记录中。
   - 在个人失物/招领记录中点击任意记录查看详细信息，可点击"启动智能体匹配"按钮触发智能匹配。
   - 匹配完成后，在"我的智能体匹配推荐"表格中查看推荐结果，包括等级、分数和匹配理由。
   - 在列表内点击"删除"快速移除记录，匹配表格支持"确认完成"以锁定成功结果。
   - 可在"最新记录"模块浏览全站所有用户的失物与招领信息。
   - 首次注册的账号会自动成为管理员，用于后续授权与数据维护；其他账号默认是普通用户。
7. 若此前已生成旧版本数据库，请删除 `data/lost_and_found.db` 以加载新增字段。

### 常见问题：Internal Server Error

若浏览器提示 “Internal Server Error”，可按照以下步骤排查：

1. **查看日志定位异常**
   - Docker 部署：`docker compose logs -f web`
   - 本地调试：`flask run --debug` 后刷新页面，在终端查看 traceback。
2. **数据库缺少新字段**
   - 日志若显示 `no such column` 等错误，删除旧数据库并重启：
     ```powershell
     Remove-Item .\data\lost_and_found.db
     flask run --debug
     ```
     Docker 环境删除本地 `data` 目录，再执行 `docker compose -p lost-and-found up --build`。
3. **依赖缺失**
   - 若日志提示模块不存在，重新安装依赖：`pip install -r requirements.txt`
4. **其他错误**
   - 将完整日志粘贴给开发者或在 Issue 中反馈，以便进一步定位。

## Docker 部署

1. 首次部署推荐直接运行：
   ```powershell
   docker compose -p lost-and-found up --build
   ```
   - 如遇命令无法识别，可尝试 `docker-compose -p lost-and-found up --build`（旧版 Docker Desktop）。
   - 若提示找不到命令，请先安装并启动 Docker Desktop，并确保命令已加入系统 PATH。
2. 首次启动会自动创建挂载目录 `data/lost_and_found.db`，日志将显示 Gunicorn 监听地址。
3. 访问 http://127.0.0.1:5000 并按“本地运行”步骤中的业务流程体验系统。
4. 若需停止容器：
   ```powershell
   docker compose -p lost-and-found down
   ```

### 管理员账号与权限

- 管理员可查看并删除全部失物、招领记录；普通用户仅能查看、确认自己提交的数据。
- 首个注册的账号自动拥有管理员权限。
- 需要手动提升其他账号为管理员时，执行：
   ```powershell
   flask promote-admin <用户名>
   ```
   若在 Docker 容器内，请通过 `docker compose exec web flask promote-admin <用户名>` 运行上述命令。

## 智能体匹配决策策略

系统采用**分层规则引擎**来计算失物与招领的匹配得分，设计原则是在保证精准度的同时降低误触发。匹配过程采用**权重化评分机制**，综合考虑以下因素：

| 因素 | 权重 | 说明 |
|------|------|------|
| **物品类别** | 40% | 最重要的匹配基础，类别必须完全相同 |
| **发生地点** | 30% | 地理位置相近性，相同地点提分 |
| **时间差异** | 15% | 发生时间的接近度，时间差越小评分越高 |
| **描述相似度** | 15% | 物品描述的文本相似性与关键词重合 |

### 匹配规则（按优先级递减）

1. **完美匹配（98分 - 高匹配）**  
   类别完全相同 + 地点相同 + 时间差不超过2天

2. **强匹配（90分 - 高匹配）**  
   类别完全相同 + 地点相同 + 描述相似度 ≥ 50%

3. **类别+描述匹配（80分 - 中匹配）**  
   类别相同 + (描述相似度 ≥ 65% 或关键词重合 ≥ 3个)

4. **类别+地点匹配（75分 - 中匹配）**  
   类别相同 + 地点相同 + 时间差 ≤ 7天

5. **类别+时间匹配（70分 - 中匹配）**  
   类别相同 + 时间差 ≤ 5天 + 关键词重合 ≥ 1个

6. **描述+地点匹配（65分 - 中匹配）**  
   描述相似度 ≥ 60% + 地点相同

7. **弱相关匹配（55分 - 低匹配）**  
   (类别相同 + 描述相似度 ≥ 40%) 或 (描述相似度 ≥ 50% + 关键词重合 ≥ 2个)

8. **地点+描述弱匹配（45分 - 低匹配）**  
   地点相同 + 关键词重合 ≥ 2个 + 描述相似度 ≥ 35%

### 手动触发与自动匹配

- **手动触发**：用户在个人记录详情页点击"启动智能体匹配"按钮，触发该记录与所有可匹配对象的评分。
- **结果展示**：匹配结果在"我的智能体匹配推荐"表格中显示，仅展示当前登录用户相关的匹配。
- **确认完成**：用户可点击"确认完成"标记某个匹配为已完成，避免重复推荐。
   ```
4. 服务器执行：
   ```bash
   docker compose -p lost-and-found up --build -d
   ```
   - `-d` 以后台模式运行，Gunicorn 会监听 0.0.0.0:5000。
5. 开放服务器安全组/防火墙的 5000 端口，或通过 Nginx 反向代理至域名（可启用 HTTPS）。
6. 客户端直接访问 `http://<服务器IP或域名>:5000`，即可多人同时登录、发布与确认匹配。
7. 若需数据备份，可定期导出 `data/lost_and_found.db` 或切换到云数据库以获得更好的并发性能。

## 目录结构

```
├── agent/                # 规则型智能体
├── models/               # 数据模型定义
├── services/             # 业务服务层
├── templates/            # 前端模板
├── tests/                # 单元测试
├── app.py                # Flask 入口
├── config.py             # 配置与常量
├── database.py           # SQLAlchemy 实例
├── docker-compose.yml
├── Dockerfile
├── requirements.txt
└── README.md
```

## 运行测试

```bash
pytest
```

如需切换数据库或秘钥，可通过环境变量 `DATABASE_URL`、`SECRET_KEY` 覆盖默认配置。
